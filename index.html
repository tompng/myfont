<meta charset='utf-8'>
<title>手書きぺんの筆跡</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src='moji.js'></script>
<script src='template.js'></script>
<script src='smooth_random.js'></script>
<script>
var renderers = {
  round: function(g,arr){
    g.beginPath();
    g.lineWidth=0.15;
    g.lineCap='round'
    g.lineJoin='round'
    Moji.toLines(arr).forEach(function(line){
      g.moveTo(line[0].x,line[0].y);
      for(var i=1;i<line.length;i++)g.lineTo(line[i].x,line[i].y);
    })
    g.stroke();
  },
  pen: function(g,arr){
    Moji.toDoubledLines(arr,6).forEach(function(line){
      var weight=new SmoothRandom();
      var prev=null;
      line.forEach(function(p){
        var l=0;
        if(prev){
          var dx=p.x-prev.x,dy=p.y-prev.y;
          l=Math.sqrt(dx*dx+dy*dy);
        }
        prev=p;
        var r=0.05*Math.exp(0.2*weight.next(l*8))
        g.beginPath();
        g.arc(p.x,p.y,r,0,2*Math.PI);
        g.fill();
      })
    })
  },
  lines: function(g,arr){
    for(var k=0;k<20;k++){
    Moji.toDoubledLines(arr,4).forEach(function(line){
      var xpos=new SmoothRandom();
      var ypos=new SmoothRandom();
      var weight=new SmoothRandom();
      var prev=null;
      g.beginPath();
      g.lineWidth=0.01;
      g.lineCap='round';
      g.lineJoin='round';
      g.globalAlpha=0.5;
      g.moveTo(line[0].x,line[0].y);
      for(var i=0;i<line.length;i++){
        var p=line[i];
        var l=0;
        if(prev){
          var dx=p.x-prev.x,dy=p.y-prev.y;
          l=Math.sqrt(dx*dx+dy*dy);
        }
        prev=p;
        var r=weight.next(l*4);
        var x=0.015*xpos.next(l*8);
        var y=0.015*ypos.next(l*8);
        r=0.005*Math.exp(0.2*r)
        if(i==0)g.moveTo(p.x+x,p.y+y);
        else g.lineTo(p.x+x,p.y+y);
      }
      g.stroke();
    })
    }
  },
  brush: function(g,arr){
    Moji.toDoubledLines(arr,10).forEach(function(line){
      var linelength=0;for(var i=1;i<line.length;i++){
        var dx=line[i].x-line[i-1].x,dy=line[i].y-line[i-1].y;
        linelength+=Math.sqrt(dx*dx+dy*dy);
      }
      var weight=new SmoothRandom();
      var params=[];for(var i=0;i<4;i++)params[i]=new SmoothRandom();
      var prev=null;
      var randalpha = 0.6+0.8*Math.random();
      line.forEach(function(p){
        var l=0;
        if(prev){
          var dx=p.x-prev.x,dy=p.y-prev.y;
          l=Math.sqrt(dx*dx+dy*dy);
        }
        prev=p;
        r=0.14*Math.exp(0.2*weight.next(l*8))
        for(var i=0;i<4;i++){
          var alpha=Math.exp(0.5*params[i].next(l*8))
          g.globalAlpha=0.08*randalpha*alpha/Math.max(100*l,1)*linelength;
          g.drawImage(renderers.brush.brushes[i],p.x-r/2,p.y-r/2,r,r);
        }
      })
    })
  },
}

$(function(){
  renderers.brush.brushes=[];
  for(var i=0;i<4;i++){
    var img=new Image()
    img.src='brush/'+i+'.png';
    renderers.brush.brushes[i]=img;
  }
  $('textarea, input').on('input',renderAll)
  $('textarea, input, select').on('change',renderAll)
  window.onresize=renderAll;
  renderAll();
  $(document).on('click', 'canvas, img', renderAll);
  function splitCharPos(text){
    var line=[],ix=0;
    var lines=[line]
    for(var i=0;i<text.length;i++){
      var c=text[i];
      if(c=='\n'){ix=0;lines.push(line=[]);continue;}
      var w=(c.charCodeAt(0)<128?0.5:1);
      var template = HIRAGANA_TEMPLATES[c]||HIRAGANA_TEMPLATES[HIRAGANA_ALIAS[c]];
      if(template){
        if(ix+w>10){ix=0;lines.push(line=[])};
      }else{
        if(ix+w>10){console.log(c)};
      }
      if(template)line.push({x:ix,y:lines.length-1,w:w,template:template});
      ix+=w;
    }
    return lines;
  }

  function renderAll(){
    var $canvas = $('<canvas>');
    var render = renderers[$('select').val()]
    var text = $('textarea').val();
    var transparent = $('input[type=checkbox]').is(':checked');
    var charspos=splitCharPos(text);
    var width=$('body').width();
    var fontSize=width/11;
    var lineHeight=fontSize*1.4;
    var marginY=fontSize*0.2;
    var marginX=0.3*fontSize;
    var lineNum=charspos.length||1;
    var height=marginY*2+lineHeight*lineNum;
    $canvas.attr({width:width,height:height});
    var g=$canvas[0].getContext('2d');
    g.clearRect(0,0,width,height);
    if(!transparent){
      g.fillStyle='white';
      g.fillRect(0,0,width,height);
    }
    g.fillStyle='black';
    charspos.forEach(function(lines){
      lines.forEach(function(o){
        g.save();
        g.translate(
          marginX+(o.x+o.w/2-0.5)*fontSize,
          marginY+(o.y+0.5)*lineHeight-fontSize/2+Math.sin(o.x+o.y*o.y)*(lineHeight-fontSize)*0.2
        )
        g.scale(fontSize,fontSize);
        g.translate(-0.1,-0.1);g.scale(1.2,1.2);
        render(g,new Moji(o.template).random())
        g.restore();
      });
    });
    g.save();
    g.translate(
      width-fontSize*0.6,
      marginY+(lineNum-0.5)*lineHeight-fontSize*0.1);
    g.scale(fontSize*0.5, fontSize*0.5);
    renderLogo(g,$('input').val(),transparent);
    g.restore();
    createLink($canvas);
  }
  function createLink($canvas){
    $('span').empty();
    $('img, canvas').remove();
    try{
      var url=$canvas.get(0).toDataURL();
      $("<a download='tegaki.png'>download</a>").attr('href',url).appendTo('span');
      $('<img>').attr('src',url).appendTo('body');
    }catch(e){
      $canvas.appendTo('body');
    }
  }
  function renderLogo(g,c,transparent){
    if(!c)return;
    var template=HIRAGANA_TEMPLATES[c[0]];
    if(!template)return;
    g.fillStyle='#d10';
    var N=100;
    var rnd1=2*Math.random()-1;
    var rnd2=2*Math.random()-1;
    var pat=function(t){
      t*=2*Math.PI;
      var x=Math.cos(t),y=Math.sin(t);
      var r=1-Math.cos(4*t)/8+Math.cos(8*t)/16
      var a=Math.sqrt(2)-1/Math.max(Math.abs(x),Math.abs(y));
      r=(Math.sqrt(2)-Math.sqrt(0.01+a*a));
      r+=Math.cos(3*t)*rnd1/40+Math.sin(5*t)*rnd2/40;
      x*=r;y*=r;
      return {x:0.5+0.5*x,y:0.5+0.5*y}
    }
    g.beginPath();
    g.moveTo(pat(0).x,pat(0).y);
    for(var i=0;i<N;i++){
      var a=pat((i+1/3)/N),b=pat((i+2/3)/N),c=pat((i+1)/N);
      g.bezierCurveTo(a.x,a.y,b.x,b.y,c.x,c.y);
    }
    g.fill();
    g.fillStyle='white'
    if(transparent){
      g.globalCompositeOperation = "destination-out";
    }else{
      g.globalCompositeOperation = "source-over";
    }
    renderers.pen(g, new Moji(template).random());
  }
})

</script>
<style>
body{margin:0;}
div{margin: 5px;}
span{float:right;}
img,canvas{background:url(tile.png);width:100%;}
</style>
<div>
mode(筆推奨):<select>
  <option value=round>シンプル</option>
  <option value=pen selected>ペン</option>
  <option value=lines>線</option>
  <option value=brush>筆(重いです 文章を決めてから選んでね)</option>
</select>
&nbsp;&nbsp;&nbsp;
logo:<input value='ぺ'>
<label><input type=checkbox>透過</label>
<span></span>
<textarea style='width:100%;height:160px;font-size:20px;'>
ごみばこ
 けとばしたって
いいじゃないか！
 みつをだもの
       \(^o^)/ぺんし</textarea>
</div>
